<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>综合分析-系统分析-通讯系统分析</title>
    <link href="../../Script/layui/css/layui.css" rel="stylesheet" type="text/css"/>
    <link href="../../Script/layer/skin/default/layer.css" rel="stylesheet" type="text/css"/>
    <link href="../../Script/jquery-scrollbar/jquery.scrollbar.css" rel="stylesheet" type="text/css"/>
    <link href="../../Script/My97DatePicker/skin/WdatePicker.css" rel="stylesheet" type="text/css"/>

    <link href="../../Content/css/public.css" rel="stylesheet" type="text/css"/>
    <link href="../../Content/css/AggregateAnalysis/System1.css" rel="stylesheet" type="text/css"/>

    <style>
        .table_box{
            height: 70%;
        }
    </style>

    <script src="../../Script/jquery-1.11.0.js"></script>
    <script src="../../Script/Echarts/echarts.min.js"></script>
    <script src="../../Script/layui/layui.js"></script>
    <script src="../../Script/layer/layer.js"></script>
    <script src="../../Script/public.js"></script>
    <script src="../../Script/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="../../Script/SuperSlide/jquery.SuperSlide.2.1.1.js"></script>
    <script src="../../Script/My97DatePicker/WdatePicker.js"></script>
</head>

<body>
    <div class="wrapper">     

        <div class="top-search">
            <form class="layui-form" action="" autocomplete="off">
                <!--下拉框-->
                <input class="selectTime timeStart" id="sData2" onfocus="var d5222 = $dp.$('eData2'); WdatePicker({ skin: 'whyGreen', onpicked: function () { d5222.focus(); }, maxDate: '#F{$dp.$D(\'eData2\')||\'%y-%M-%d\'}' })">
                -
                <input class="selectTime timeEnd" id="eData2" onfocus="WdatePicker({ skin: 'whyGreen', minDate: '#F{$dp.$D(\'sData2\')}', maxDate: '%y-%M-%d' })">

                <input class="selectB name" id="keyWords" type="search" placeholder="请输入关键字搜索">
                <input class="submitBtn" type="button" value="查询">

            </form>

            <div class="timeBTChose">
                <span>月</span>
                <span>季</span>
                <span>年</span>
            </div>
        </div>

        <section>
            <div class="box4">
                <div id="Chkchart1"></div>
                <div id="Chkchart2">
                    <div class="msgDataBox">
                        <div id="ChkTotalData" class="fontSize20">0</div>
                        <div class="fontSize12">短信统计</div>                       
                    </div>
                    <div class="msgBgBox"></div>
                </div>
                <div id="Chkchart3"></div>

                <!--<div class="circleBox1">-->
                    <!--<div id="" class="totalData fontSize20">325</div>-->
                    <!--<div class="fontSize12">电话统计</div>-->
                <!--</div>-->

                <div class="circleBox3">
                    <!--<div id="" class="totalData fontSize20">335,453</div>-->
                    <!--<div class="fontSize12">流量统计</div>-->
                </div>
            </div>

            <!--table start-->
            <div class="table_box">
                <div class="list_table">
                    <div class="table_header">
                        <table>
                            <colgroup>
                                <col width="7%">
                                <col width="15%">
                                <col width="12%">
                                <col width="15%">
                                <col width="10%">
                                <col width="10%">
                                <col width="10%">
                                <col width="10%">
                            </colgroup>
                            <thead>
                            <tr>
                                <th>序号</th>
                                <th>单位编号</th>
                                <th>子站号</th>
                                <th>单位名称</th>
                                <th>接通次数</th>
                                <th>接通时长</th>
                                <th>拨通次数</th>
                                <th>通话率</th>
                                <th>接通率</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="table_content scrollbar-inner">
                        <table cellpadding="0" cellspacing="0" class="tbody">
                            <colgroup>
                                <col width="7%">
                                <col width="15%">
                                <col width="12%">
                                <col width="15%">
                                <col width="10%">
                                <col width="10%">
                                <col width="10%">
                                <col width="10%">
                            </colgroup>
                            <tbody id="mainContentTbody1">
                                
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="footer">
                    <div id="demo1" class="pagedemo"></div>
                    <img class="exportBtn" id="exportBtn1" src="../../Content/images/Public/exportBT.png">
                </div>

            </div>
            <!--table end-->

            <!--table start-->
            <div class="table_box" style="display: none">
                <div class="list_table">
                    <div class="table_header">
                        <table>
                            <colgroup>
                                <col width="7%">
                                <col width="15%">
                                <col width="15%">
                                <col width="20%">
                                <col width="15%">
                                <col width="14%">
                                <col width="14%">
                            </colgroup>
                            <thead>
                            <tr>
                                <th>序号</th>
                                <th>单位编号</th>
                                <th>子站号</th>
                                <th>单位名称</th>
                                <th>联系人</th>
                                <th>发送手机号</th>
                                <th>短信数</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="table_content scrollbar-inner">
                        <table cellpadding="0" cellspacing="0" class="tbody">
                            <colgroup>
                                <col width="7%">
                                <col width="15%">
                                <col width="15%">
                                <col width="20%">
                                <col width="15%">
                                <col width="14%">
                                <col width="14%">
                            </colgroup>
                            <tbody id="mainContentTbody2">

                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="footer">
                    <div id="demo2" class="pagedemo"></div>
                    <img class="exportBtn" id="exportBtn2" src="../../Content/images/Public/exportBT.png">
                </div>

            </div>
            <!--table end-->

            <!--table start-->
            <div class="table_box" style="display: none">
                <div class="list_table">
                    <div class="table_header">
                        <table>
                            <colgroup>
                                <col width="7%">
                                <col width="13%">
                                <col width="11%">
                                <col width="14%">
                                <col width="11%">
                                <col width="10%">
                                <col width="8%">
                                <col width="12%">
                                <col width="12%">
                            </colgroup>
                            <thead>
                            <tr>
                                <th>序号</th>
                                <th>单位编号</th>
                                <th>子站号</th>
                                <th>单位名称</th>
                                <th>联系人</th>
                                <th>发送手机号</th>
                                <th>总流量(兆)</th>
                                <th>发出流量(兆)</th>
                                <th>接收流量(兆)</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="table_content scrollbar-inner">
                        <table cellpadding="0" cellspacing="0" class="tbody">
                            <colgroup>
                                <col width="7%">
                                <col width="13%">
                                <col width="11%">
                                <col width="14%">
                                <col width="11%">
                                <col width="10%">
                                <col width="8%">
                                <col width="12%">
                                <col width="12%">
                            </colgroup>
                            <tbody id="mainContentTbody3">

                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="footer">
                    <div id="demo3" class="pagedemo"></div>
                    <img class="exportBtn" id="exportBtn3" src="../../Content/images/Public/exportBT.png">
                </div>

            </div>
            <!--table end-->


        </section>
    </div>
</body>

<script type="text/javascript">
    var _ifPhoneUsed = 0,_ifMsgUsed= 0,_ifFlowUsed=0; //调用page方法的判断
    var _countdata = {
        pageSize:20,
        pageNumber:1,
        startDate:$('#sData2').val(),
        endDate:$('#eData2').val(),
        keyword:$('#keyWords').val()
    };
    var _data = {
        pageSize:20,
        pageNumber:1,
        startDate:$('#sData2').val(),
        endDate:$('#eData2').val(),
        keyword:$('#keyWords').val()
    };
    var _dataFlow = {
        pageSize:20,
        pageNumber:1,
        startDate:$('#sData2').find('dd.layui-this').attr('lay-value')||"",
        endDate:$('#eData2').find('dd.layui-this').attr('lay-value')||"",
        keyword:$('#keyWords').val(),
        unitId:""
    }

    $(function(){
        loadLayuiForm();//调用layui form组件，方法写在public
        getSysCountData(); // 获取统计数据

        getSysPhoneList();//获取电话列表数据

        getSysMsgList();//获取短信列表数据

        getDataFlowList();//获取流量列表数据

        clickevent();
    });

    function getSysCountData(){
        var isAsync = true,lid = 0;
        if (isAsync)
            lid = layer.msg('正在加载...', { icon: 16, shade: [0.1, '#fff'], time: 90000 });
        $.ajax({
            type: "get",
            url: _serverIp + "/front/analysis/getCommunicationCount",
            data:_countdata,
            success: function (data) {
                //console.log(data);
                var msg = data.obj;
                $('#ChkTotalData').text(msg.messageCount || 0);//短信
                loadData1('Chkchart1',"电话统计",["#00F5D6","#FF7623"],[{name:"拨通次数",value:(msg.phoneSucCount || 0)},{name:"接通次数",value:(msg.phoneAnswerCount || 0)}]); //电话统计

                loadData1('Chkchart3',"流量统计(MB)",["#35B4F2","#825ED1"],[{name:"发出流量",value:(msg.sendCount || 0)},{name:"接收流量",value:(msg.receiveCount || 0)}]); //流量统计
            },
            complete: function () {
                if (isAsync){
                    layer.close(lid);
                }
            }
        });
    }

    //获取电话列表数据
    function getSysPhoneList(){
        var isAsync = true,lid = 0;
        if (isAsync)
            lid = layer.msg('正在加载...', { icon: 16, shade: [0.1, '#fff'], time: 90000 });
        $.ajax({
            type: "get",
            url: _serverIp + "/front/analysis/getPhoneList",
            data:_data,
            success: function (data) {
                //console.log(data);
                if (_ifPhoneUsed == 0) {
                    layerPage(data.total,1);
                    _ifPhoneUsed = 1;
                }
                showPhoneListContent(data);
            },
            complete: function () {
                if (isAsync){
                    layer.close(lid);
                }
            }
        });
    }

    function showPhoneListContent(msg){
        var data = msg.list;
        var html="";
        for(var i = 0 ; i < data.length;i++){
            var phoneAnswerSuccess= 0,phoneSuccess=0;
            if(data[i].phoneCount != 0){
                phoneAnswerSuccess = (data[i].phoneAnswerCount / data[i].phoneCount)*100;
                phoneSuccess = (data[i].phoneSucCount / data[i].phoneCount)*100;
            }
            html += '<tr id="'+data[i].id+'">'+
                    '<td>'+(msg.startRow++)+'</td>'+
                    '<td>'+ data[i].unitCode +'</td>'+
                    '<td>'+ data[i].childStationNum +'</td>'+
                    '<td class="align-left">'+data[i].unitName+'</td>'+
                    '<td>'+data[i].phoneAnswerCount+'</td>'+
                    '<td>'+data[i].longTime+'</td>'+
//                    '<td>'+formatSeconds(data[i].longTime)+'</td>'+
//                    '<td>-</td>'+
                    '<td>'+data[i].phoneSucCount+'</td>'+
                    '<td>'+data[i].answerRate+'%</td>'+
                    '<td>'+data[i].successRate+'%</td>'+
                    '</tr>'
        }

        $('#mainContentTbody1').html(html||"<tr><td colspan='8'>暂无数据...</td></tr>");
        $('#mainContentTbody1 tr>td').each(function(){$(this).attr('title',$(this).text())})
    }

    //获取短信列表数据
    function getSysMsgList(){
        var isAsync = true,lid = 0;
        if (isAsync)
            lid = layer.msg('正在加载...', { icon: 16, shade: [0.1, '#fff'], time: 90000 });
        $.ajax({
            type: "get",
            url: _serverIp + "/front/analysis/getMessageList",
            data:_data,
            success: function (data) {
                //console.log(data);
                if (_ifMsgUsed == 0) {
                    layerPage(data.total,2);
                    _ifMsgUsed = 1;
                }
                showMsgListContent(data);
            },
            complete: function () {
                if (isAsync){
                    layer.close(lid);
                }
            }
        });
    }

    function showMsgListContent(msg){
        var data = msg.list;
        var html="";
        for(var i = 0 ; i < data.length;i++){
            html += '<tr id="'+data[i].id+'">'+
                    '<td>'+(msg.startRow++)+'</td>'+
                    '<td>'+ data[i].unitCode +'</td>'+
                    '<td>'+ data[i].childstationnum +'</td>'+
                    '<td class="align-left">'+data[i].unitName+'</td>'+
                    '<td>'+data[i].receiver+'</td>'+
                    '<td>'+data[i].phone+'</td>'+
                    '<td>'+data[i].sendCount+'</td>'+
                    '</tr>'
        }

        $('#mainContentTbody2').html(html||"<tr><td colspan='7'>暂无数据...</td></tr>");
        $('#mainContentTbody2 tr>td').each(function(){$(this).attr('title',$(this).text())})
    }

    //获取流量列表数据
    function getDataFlowList(){
        var isAsync = true,lid = 0;
        if (isAsync)
            lid = layer.msg('正在加载...', { icon: 16, shade: [0.1, '#fff'], time: 90000 });
        $.ajax({
            type: "get",
            url: _serverIp + "/front/history/getDataFlow",
            data:_dataFlow,
            success: function (data) {
                //console.log(data);
                if (_ifFlowUsed == 0) {
                    layerPage(data.total,3);
                    _ifFlowUsed = 1;
                }
                showFlowListContent(data);
            },
            complete: function () {
                if (isAsync){
                    layer.close(lid);
                }
            }
        });

    }

    function showFlowListContent(msg){
        var data = msg.list;
        var html="";
        for(var i = 0 ; i < data.length;i++){
            html += '<tr>'+
                    '<td>'+(msg.startRow++)+'</td>'+
                    '<td>'+data[i].unitCode+'</td>'+
                    '<td>'+data[i].childstationnum+'</td>'+
                    '<td class="align-left">'+data[i].unitName+'</td>'+
                    '<td>'+data[i].contact+'</td>'+
                    '<td>'+data[i].contactPhone+'</td>'+
                    '<td>'+(Number(data[i].rx||0,3) + Number(data[i].tx||0,3)).toFixed(2)+'</td>'+
                    '<td>'+data[i].rx+'</td>'+
                    '<td>'+data[i].tx+'</td>'+
                    '</tr>'
        }

        $('#mainContentTbody3').html(html||"<tr><td colspan='9'>暂无数据...</td></tr>");
        $('#mainContentTbody3 tr>td').each(function(){$(this).attr('title',$(this).text())})
    }

    function layerPage(count,index){

        layui.use(['laypage', 'layer'], function() {
            var laypage = layui.laypage
                    , layer = layui.layer;
            laypage.render({
                elem: 'demo'+index
                ,count: count
                ,limit:20
                ,prev: '<em>&lt;</em>'
                ,next: '<em>&gt;</em>'
                ,layout: ['count','limit', 'prev', 'page', 'next',  'refresh']
                ,jump: function(obj,isNew){
                    if (!isNew) {
                        if(index == 1){
                            _countdata.pageNumber = obj.curr;
                            _countdata.pageSize = obj.limit;
                            getSysPhoneList(); //调用接口获取数据
                        }
                        if(index == 2){
                            _data.pageNumber = obj.curr;
                            _data.pageSize = obj.limit;
                            getSysMsgList(); //调用接口获取数据
                        }
                        if(index == 3){
                            _dataFlow.pageNumber = obj.curr;
                            _dataFlow.pageSize = obj.limit;
                            getDataFlowList(); //调用接口获取数据
                        }

                    }

                }
            });
        })
        //完整功能

    }

    //电话统计
    function loadData1(id,title,color,data){
        var chart1 = echarts.init(document.getElementById(id));

        var option = {
            tooltip : {
                formatter:"{b}:{c}"
            },
            color:color,
            legend:{
               show:false
            },
            series : [
                {
                    name: title,
                    type: 'pie',
                    center: ['50%', '50%'],
                    radius: ['60%', '70%'],
                    hoverAnimation:false,
                    hoverOffset:0,
                    selectedOffset:5,
                    label:{
                        normal:{
                            show:true,
                            formatter: '{d}%\n{b}'
                        }
                    },
                    labelLine:{
                        normal:{
                            length:10,
                            length2:10
                        }
                    },
                    data:data
                },
                {
                    name: title,
                    type: 'pie',
                    center: ['50%', '50%'],
                    radius: ['55%', '56%'],
                    label: {
                        normal: {
                            show: true,
                            position: 'center',
                            formatter: [
                                '{a|'+(parseFloat(data[0].value)+parseFloat(data[1].value))+'}',
                                '{b|}',
                                '{x|'+title+'}'
                            ].join('\n'),
                            rich: {
                                a: {
                                    color: '#fff',
                                    fontSize: 20,
                                    fontWeight:'bold',
                                    height: 25
                                },
                                b: {
                                    height:1,
                                    width:'100%',
                                    borderWidth:1,
                                    align:'left',
                                    borderColor:'rgba(90, 149, 202,0.5)'
                                },
                                x: {
                                    color: '#fff',
                                    fontSize: 12,
                                    lineHeight: 16
                                },
                            }
                        },
                        emphasis: {
                            show: true
                        }
                    },
                    labelLine: {
                        normal: {
                            show: false
                        }
                    },
                    hoverAnimation:false,
                    data:[
                        {value:100, name:'',itemStyle:{normal:{color:'#316DB6'}},tooltip:{show:false}}
                    ]
                }
            ]
        };

        chart1.setOption(option);

        window.addEventListener('resize', function () { //宽度自适应
            chart1.resize();
        });
    }


    function clickevent(){
        $('.submitBtn').click(function(){ //查询
            _ifPhoneUsed = 0,_ifMsgUsed= 0,_ifFlowUsed=0;
            _countdata = {
                pageSize:20,
                pageNumber:1,
                startDate:$('#sData2').val(),
                endDate:$('#eData2').val(),
                keyword:$('#keyWords').val()
            };
            _data = {
                pageSize:20,
                pageNumber:1,
                startDate:$('#sData2').val(),
                endDate:$('#eData2').val(),
                keyword:$('#keyWords').val()
            };
            _dataFlow = {
                pageSize:20,
                pageNumber:1,
                startDate:$('#sData2').val(),
                endDate:$('#eData2').val(),
                keyword:$('#keyWords').val(),
                unitId:""
            };
            getSysCountData(); // 获取统计数据
            getSysPhoneList();//获取电话列表数据
            getSysMsgList();//获取短信列表数据
            getDataFlowList();//获取流量列表数据
            //$('.box4>div.active').click(); //加载表格list
        });


        $('.box4>div').click(function(){
            _data.pageNumber = 1;
            _data.pageSize = 20;
            _ifUsed = 0;
            var _id=$(this).attr('id');
            $(this).addClass('active').siblings().removeClass('active');
            if(_id == 'Chkchart1'){
                $('.box4').css('background-image','url(../../Content/images/AggregateAnalysis/box4_1.png)');
            }else if(_id == 'Chkchart2'){
                $('.box4').css('background-image','url(../../Content/images/AggregateAnalysis/box4_2.png)');

            }else if(_id == 'Chkchart3'){
                $('.box4').css('background-image','url(../../Content/images/AggregateAnalysis/box4_3.png)');
            }else{
                return false;
            }
            var index =  $('.box4>div').index($('.box4>div.active'));
            $('.table_box').eq(index).show().siblings('.table_box').hide();
        });
        $('.box4>div').eq(0).click();

        ///////导出
        $('.exportBtn').click(function(){
            var index =  $('.box4>div').index($('.box4>div.active'));
            var name = "exportPhoneList";
            var wrap="";
            var sname = "";
            if(index == 0 ){
                name = "exportPhoneList"; //电话
                wrap = "mainContentTbody1";
                sname = "analysis";
            }
            else if( index == 1){
                name = "exportMessageList"; //短信
                wrap = "mainContentTbody2";
                sname = "analysis";
            }
            else if( index == 2){
                name = "exportDataFlow"; //单位
                wrap = "mainContentTbody3";
                sname = "history";
            }
            if( $('#'+wrap+' tr:first-child>td').length == 1){
                return;
            }
            var url = _serverIp + "/front/"+sname+"/"+name+"?"
                    + "keyword=" + $('#keyWords').val()
                    + "&startDate=" + $('#sData2').val()
                    + "&endDate=" + $('#eData2').val();
            postExport(url)
        })

        $('.timeBTChose > span').click(function(){ //月季年
            $(this).addClass('actTime').siblings().removeClass('actTime');
            var text = $(this).text();
            if(text == '月'){
                $('#sData2').val(getNowFormatDateStart());
                $('#eData2').val(getNowFormatDate());
            }else if(text == '季'){
                $('#sData2').val(getQuarterStartDate());
                $('#eData2').val(getNowFormatDate());
            }else if(text == "年"){
                $('#sData2').val(getNowYeartDateStart());
                $('#eData2').val(getNowFormatDate());
            }
            setTimeout(function(){
                $('.submitBtn').click();
            },500);
        });
    }


</script>
</html>