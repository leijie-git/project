<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>历史记录-值班记录</title>
    <link href="../../../Script/layui/css/layui.css" rel="stylesheet" type="text/css"/>
    <link href="../../../Script/layer/skin/default/layer.css" rel="stylesheet" type="text/css"/>
    <link href="../../../Script/jquery-scrollbar/jquery.scrollbar.css" rel="stylesheet" type="text/css"/>

    <link href="../../../Content/css/public.css" rel="stylesheet" type="text/css"/>
    <link href="../../../Content/css/NetInfoStatistic/system_detail.css" rel="stylesheet" type="text/css"/>

    <link href="../../../Script/My97DatePicker/skin/WdatePicker.css" rel="stylesheet" type="text/css"/>
    <script src="../../../Script/My97DatePicker/WdatePicker.js"></script>
    <script src="../../../Script/jquery-1.11.0.js"></script>
    <script src="../../../Script/Echarts/echarts.min.js"></script>
    <script src="../../../Script/layui/layui.js"></script>
    <script src="../../../Script/layer/layer.js"></script>
    <script src="../../../Script/public.js"></script>
    <script src="../../../Script/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="../../../Script/SuperSlide/jquery.SuperSlide.2.1.1.js"></script>
</head>

<body>
    <div class="wrapper">

        <div class="top-search">
            <form class="layui-form" action="" autocomplete="off">   
                <!--下拉框-->
                <div class="layui-inline layui-bg-cyan" id="deviceSys" >
                    <div class="layui-input-inline">
                        <select name="modules" lay-verify="required" lay-search="">
                            <option value="">--设备系统--</option>
                            <option value="1">灭火系统</option>
                            <option value="2">电气火灾</option>
                            <option value="3">火灾自动报警系统</option>
                            <option value="4">防火分离</option>
                            <option value="5">气体系统 </option>
                            <option value="6">燃气系统</option>
                            <option value="7">应急疏散 </option>
                            <option value="8">无线烟感</option>
                            <option value="9">防排烟系统</option>
                        </select>
                    </div>
                </div>
                <!--下拉框-->
                <div class="layui-inline layui-bg-cyan inline_deviceType"  id="deviceType">
                    <div class="layui-input-inline">
                        <select name="modules" lay-verify="required" lay-search="">
                            <option value="">--设备类型--</option>
                            <option value="1">主机</option>
                            <option value="2">用户信息传输装置</option>
                            <option value="3">数据传输模块(数字量、模拟量)</option>
                        </select>
                    </div>
                </div>
                 <!--下拉框-->      
                <div class="layui-inline layui-bg-cyan" id="deviceState" >
                    <div class="layui-input-inline">
                        <select name="modules" lay-verify="required" lay-search="">
                            <option value="">--设备状态--</option>
                            <option value="1">在线</option>
                            <option value="2">离线 </option>
                        </select>
                    </div>
                </div>
                <!--下拉框-->      
                <!-- <div class="layui-inline layui-bg-cyan" id="uploadStatus">
                    <div class="layui-input-inline">
                        <select name="modules" lay-verify="required" lay-search="">
                            <option value="">--上传状态--</option>
                            <option value="1">成功</option>
                            <option value="0">失败</option>
                        </select>
                    </div>
                </div>    -->
                <!--下拉框-->      
                <!--<div class="layui-inline layui-bg-cyan" id="result">-->
                    <!--<div class="layui-input-inline">-->
                        <!--<select name="modules" lay-verify="required" lay-search="">-->
                            <!--<option value="">&#45;&#45;软件版本&#45;&#45;</option>-->
                            <!--<option value="1">软件版本</option>-->
                            <!--<option value="2">软件版本</option>-->
                            <!--<option value="3">软件版本</option>-->
                        <!--</select>-->
                    <!--</div>-->
                <!--</div> -->
                
                <input class="selectTime timeStart" id="sData2" onfocus="var d5222 = $dp.$('eData2'); WdatePicker({dateFmt: 'yyyy-MM-dd HH:mm:ss', skin: 'whyGreen', onpicked: function () { d5222.focus(); }, maxDate: '#F{$dp.$D(\'eData2\')||\'%y-%M-%d\'}' })">
                -
                <input class="selectTime timeEnd" id="eData2" onfocus="WdatePicker({dateFmt: 'yyyy-MM-dd HH:mm:ss', skin: 'whyGreen', minDate: '#F{$dp.$D(\'sData2\')}', maxDate: '%y-%M-%d' })">
                <input class="selectB" type="search" id="keyWords" placeholder="请输入关键字搜索">
                <input class="submitBtn" type="button" value="查询">
            </form>
        </div>
        
        <!--table start-->
            <div class="table_box table_box2">
                <div class="list_table">
                    <div class="table_header">
                        <table>
                            <colgroup>
                                <col width="6%">
                                <col width="8%">
                                <col width="7%">
                                <col width="7%">
                                <col width="15%">
                                <col width="9%">
                                <col width="8%">
                                <col width="14%">
                                <col width="8%">
                                <col width="6%">
                                <col width="6%">
                                <col width="6%">
                            </colgroup>
                            <thead>
                            <tr>
                                <th>序号</th>
                                <th class="align-left">设备类型</th>
                                <th>设备名称</th>
                                <th>子号</th>
                                <th>使用时间</th>
                                <th class="align-left">当前状态</th>
                                <th>上传数</th>
                                <th>所属单位名称</th>
                                <th>单位编号</th>
                                <th>异常次数</th>
                                <th>硬件版本</th>
                                <th>软件版本</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="table_content scrollbar-inner">
                        <table cellpadding="0" cellspacing="0" class="tbody">
                            <colgroup>
                                <col width="6%">
                                <col width="8%">
                                <col width="7%">
                                <col width="7%">
                                <col width="15%">
                                <col width="9%">
                                <col width="8%">
                                <col width="14%">
                                <col width="8%">
                                <col width="6%">
                                <col width="6%">
                                <col width="6%">
                            </colgroup>
                            <tbody id="mainContentTbody">

                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="footer">
                    <div id="demo7"></div>
                    <img class="exportBtn" id="exportBtn" src="../../../Content/images/Public/exportBT.png">
                </div>

            </div>
            <!--table end-->
    </div>
</body>

<script type="text/javascript">
    var _ifUsed = 0; //调用page方法的判断
    var _unitid = GetQuery('unitid');
    var _buildid = GetQuery('buildid');
    var _systemid = GetQuery('sysid');
    var incoid = GetQuery('incoid');
    var _data = {
        pageSize:20,
        pageNumber:1,
        eqSystem:_systemid,
        type:$('#deviceType').find('dd.layui-this').attr('lay-value')||"",
        upStatus:$('#uploadStatus').find('dd.layui-this').attr('lay-value')||"",
        status:$('#deviceState').find('dd.layui-this').attr('lay-value')||"",
        softVersion:"",
        keyword:$('#keyWords').val(),
        buildId:_buildid,
        unitId:_unitid
    };

    $(function(){
        loadLayuiForm();//调用layui form组件，方法写在public
        getAlarmSysListData();
        clickevent();
    });

    function getAlarmSysListData(){
        var isAsync = true,lid = 0;
        if (isAsync)
            lid = layer.msg('正在加载...', { icon: 16, shade: [0.1, '#fff'], time: 90000 });
        $.ajax({
            type: "get",
            url: _serverIp + "/front/history/getSDDeviceStatusList",
            data:_data,
            success: function (data) {
                //console.log(data);
                if (_ifUsed == 0) {
                    layerPage(data.total);
                    _ifUsed = 1;
                }
                showAlarmListContent(data);
            },
            complete: function () {
                if (isAsync){
                    layer.close(lid);
                }
            }
        });
    }

    function showAlarmListContent(msg){
        var data = msg.list;
        var html="";
        for(var i = 0 ; i < data.length;i++){
            var isDeal= '<span class="underline" onlick="deal(this);">'+data[i].dealCode+'</span>';
            if(data[i].isdeal == 0){
                isDeal = '<img src="../../../Content/images/NetInfoStatistic/chuli.png"><span class="underline" onlick="deal(this);">处理</span>'
            }

            html += '<tr id="'+data[i].id+'">'+
                    '<td>'+(msg.startRow++)+'</td>'+
                    '<td class="align-left">'+data[i].deviceType+'</td>'+
                    '<td class="align-left">'+data[i].deviceName+'</td>'+
                    '<td>'+data[i].deviceNo+'</td>'+
                    '<td>'+data[i].time+'</td>'+
                    '<td class="align-left"><span class="underline '+getAlarmStatue(data[i].deviceStatus)+'" onclick="getEqIsOnline(this);">'+data[i].deviceStatus+'</span></td>'+
                    '<td><span class="underline lookUpCount">查看</span></td>'+
                    '<td class="align-left">'+data[i].unitName+'</td>'+
                    '<td>'+data[i].unitCode+'</td>'+
                    '<td>'+data[i].exceptionCount+'</td>'+
                    '<td>'+data[i].version+'</td>'+
                    '<td>'+data[i].softVersion+'</td>'+
                    '</tr>'
        }

        $('#mainContentTbody').html(html||"<tr><td colspan='12'>暂无数据...</td></tr>");
        $('#mainContentTbody tr>td').each(function(){$(this).attr('title',$(this).text())})
    }

    function getAlarmStatue(key){
        var value = "red";
        if(key == "在线" || key == "RTU正常" || key == "报警主机正常"){
            value = 'lightblue'
        }
        return value
    }


    function clickevent(){

        //搜索
        $('.submitBtn').click(function() {
            _ifUsed = 0;
            _data.type=$('#deviceType').find('dd.layui-this').attr('lay-value')||"";
            _data.upStatus=$('#uploadStatus').find('dd.layui-this').attr('lay-value')||"";
            _data.status = $('#deviceState').find('dd.layui-this').attr('lay-value')||"";
            _data.keyword=$('#keyWords').val();
            _data.eqSystem=$("#deviceSys").find('dd.layui-this').attr('lay-value')||"";
            getAlarmSysListData();
        });

        $('#exportBtn').click(function(){
            if( $('#mainContentTbody tr:first-child>td').length == 1){
                return;
            }
            var _type = $('#deviceType').find('dd.layui-this').attr('lay-value')||"";
            var _upStatus = $('#uploadStatus').find('dd.layui-this').attr('lay-value')||"";
            var url = _serverIp + "/front/history/exportSDDeviceStatusList?"
                    + "eqSystem=" + _systemid
                    + "&type=" + _type
                    + "&upStatus=" + _upStatus
                    + "&softVersion="
                    + "&keyword=" + $('#keyWords').val()
                    +"&unitId="+ _unitid
                    +"&buildId=" +_buildid;

            postExport(url)
        })
        
        //查看上传数
        $('#mainContentTbody').delegate('.underline.lookUpCount','click',function(){
            var id = $(this).parents('tr').attr('id');
            var url;
            var startDate = $('#sData2').val();
            var endDate = $('#eData2').val();
            var isAsync = true,lid = 0;
            if (isAsync)
                lid = layer.msg('正在加载...', { icon: 16, shade: [0.1, '#fff'], time: 90000 });
            $.ajax({
                type: "get",
                url: _serverIp + "/front/history/getDeviceUploadCount",
                data:'deviceId='+id+'&startDate='+startDate+'&endDate='+endDate,
                async:isAsync,
                success: function (data) {
//                    console.log(data);
                    if(!data.success){
                        return;
                    }
                    layer.open({
                        type: 1,
                        title: '上传数',
                        closeBtn: 1,
                        area:['300px','140px'],
                        shade: 0.1,
                        skin: 'layui-layer-signOut',
                        content:"<div class='fontSize20' style='line-height: 78px'>"+data.obj+"</div>"
                    });
                },
                complete: function () {
                    if (isAsync){
                        layer.close(lid);
                    }
                }
            });


        })

    }



    function layerPage(count){
        layui.use(['laypage', 'layer'], function() {
            var laypage = layui.laypage
                    , layer = layui.layer;
            laypage.render({
                elem: 'demo7'
                ,count: count
                ,limit:20
                ,prev: '<em>&lt;</em>'
                ,next: '<em>&gt;</em>'
                ,layout: ['count','limit', 'prev', 'page', 'next',  'refresh']
                ,jump: function(obj,isNew){
//                    console.log(obj);
                    if (!isNew) {
                        _data.pageNumber = obj.curr;
                        _data.pageSize = obj.limit;
                        //console.log(_curr)
                        getAlarmSysListData(); //调用接口获取数据
                    }

                }
            });
        })
        //完整功能

    }

    //设备离在线情况弹窗
    function getEqIsOnline(obj){
        var id=$(obj).parents('tr').attr('id');

        layer.open({
            type: 2,
            title: '设备离在线情况',
            closeBtn: 1,
            area:['70%','80%'],
            shade: 0.1,
            skin: 'layui-layer-loginRecord',
            content: 'History12_EqIsOnline.html?id='+id+'&unitid='+_unitid
        });
    }

</script>
</html>